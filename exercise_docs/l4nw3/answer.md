<!-- HEADER -->
[Previous](../l4nw3/question.md) << [Index](../index.md) >> [Next](../app1/question.md)

---
<!-- /HEADER -->

<!-- TOC -->

- [L4NW-3 解説編](#l4nw-3-%E8%A7%A3%E8%AA%AC%E7%B7%A8)
  - [問題1](#%E5%95%8F%E9%A1%8C1)
  - [L3 観点の経路確認](#l3-%E8%A6%B3%E7%82%B9%E3%81%AE%E7%B5%8C%E8%B7%AF%E7%A2%BA%E8%AA%8D)
  - [L4 観点のファイアウォール設定確認](#l4-%E8%A6%B3%E7%82%B9%E3%81%AE%E3%83%95%E3%82%A1%E3%82%A4%E3%82%A2%E3%82%A6%E3%82%A9%E3%83%BC%E3%83%AB%E8%A8%AD%E5%AE%9A%E7%A2%BA%E8%AA%8D)
  - [まとめ](#%E3%81%BE%E3%81%A8%E3%82%81)

<!-- /TOC -->

# L4NW-3 (解説編)

図 1: l4nw3/question (`exercise/l4nw3/question.json`)

![Route](topology.drawio.svg)

## 問題1

回答

|No.| Web 接続                       |Web 接続できる?|
|---|--------------------------------|---------------|
| 1 |`hb curl -m 3 192.168.0.2:8080` | ok |
| 2 |`hb curl -m 3 192.168.0.10:8080`| NG (Connection refused) |
| 3 |`hb curl -m 3 192.168.0.6:8080` | ok |
| 4 |`hb curl -m 3 192.168.0.14:8080`| NG (Connection refused) |
| 5 |`hc curl -m 3 192.168.0.2:8080` | ok |
| 6 |`hc curl -m 3 192.168.0.10:8080`| NG (Connection timed out) |
| 7 |`hc curl -m 3 192.168.0.6:8080` | NG (Connection refused) |
| 8 |`hc curl -m 3 192.168.0.14:8080`| ok |

ポイント

* Web サーバに接続できない事象が 2 種類あります。
  * No.2/4/7 と No.6 の違いはなぜ起きるのか? (後述)
* L3 観点でみたときの行きと帰りの経路、ファイアウォール (rb) のパケットフィルタルールと照らし合わせて、どこで何がフィルタされているか?

## L3 観点の経路確認

まず L3 観点の動作を確認します。
Host.B/C から Server.A1/A2 の各インタフェースへの通信は、対称になるものと非対称になるものがあります。これは図 1 のデフォルトルート設定からもある程度わかります。各サーバは、基本的に eth0 (Router.B) 側に優先してトラフィックを転送します。eth0 側からリクエストが届いた場合は対称になりますが、eth1 側からリクエストが届いた場合、eth0 側からリプライを返すため、結果として非対称経路が発生します。

* 対称になる: No.1/3/5/7 および __No.8__
  * No.8 については、Server.A2-Host.C 通信を対称にするための静的経路が Server.A2 で設定されている点に注意してください。
* 非対称になる: No.2/4/6

## L4 観点のファイアウォール設定確認

次に L4 観点の動作を確認します。Router.B には次のようなパケットフィルタルールが設定されています (FORWARD chain)。主要なルールは 2 番目・3 番目です。これは Host.B/C から Server.A1/A2 への通信を考えたときに、基本的に Router.B 側からだけを許可したいというルールです。

1. ICMP (ping) は全て許可
2. 192.168.0.16/30 (NW.B) → 192.168.0.0/29 (NW.q1,q2) の tcp 通信は許可 (/29 指定している点に注意)
3. 192.168.0.24/30 (NW.C) → 192.168.0.0/30 (NW.q1) の tcp 通信は許可
4. セッション確立した TCP 通信は許可
5. それ以外の通信は拒否 (REJECT)
    * これはデフォルトの転送ポリシ (DROP) を上書きするための設定です。(iptables の仕様上、REJECT はポリシではなくアクションなので、デフォルトポリシに REJECT を指定できない)
6. デフォルトの転送ポリシは拒否 (DROP)

図 2 : L3 経路と TCP 通信のフィルタ箇所

![Router and filter](ans.drawio.svg)

表 No.1-4, Host.B の通信を考えます。

* Host.B の通信は全て Router.B (FW) を経由します。
* (フィルタ)ルール 2 より、Router.B 経由で各サーバの eth0 側への通信は許可されます。対称な経路なので戻りもルール 4 により許可されます。(表 No.1,3)
* ルール 3 より、Router.B-Router.C- 各サーバ eth1 側への通信は許可されていません。リクエスト(行き)は拒否 (REJECT) されます。(表 No.2,4)

表 No.5-8, Host.C の通信を考えます。

* ファイアウォールを経由する通信は、表 No.5,7 です。
  - No.5 は eth0 側への通信なので許可されています。
  - No.7 は eth1 側への通信なので許可されていません。リクエスト(行き)は拒否 (REJECT) されます。
* No.6, リクエスト(行き)はそもそも Router.B を経由しません。しかし、戻りが Router.B を経由します。
  * Router.B は各サーバの eth0 側 (NW.q1,q2) への転送しか許していないので、TCP のレスポンス(戻り)を NW.C へ転送することは拒否 (REJECT) されます。
  * REJECT によるエラー通知は、送信元である Server.A1 へ返されています。最初にリクエストを要求した Host.C には何も通知が返されないため、タイムアウトします。
* No.8 は Router.B を経由しない対称の経路なのでファイアウォールにフィルタされません。

## まとめ

[L4NW-1](../l4nw1/question.md) と合わせて、L3/L4 のエラー事象をさらにいくつか見ることができました。通信は複数のノード・複数のレイヤによって成立していますから、特定のレイヤ・特定のノードの動作にだけ着目していても問題はわかりません。問題がおきている通信の経路・経路の中間にあるノード、それらが各レイヤでどのように動くのか、複数の観点での切り分けが必要になります。

* L3 側で通信ができているか・どのような経路になっているか
* L3 経路上のどこに、どのようなファイアウォールがあるか
* そもそも L4 で通信したいアプリケーション (サーバプロセス) は正常に起動しているか

これらの条件が全て成立して初めて、アプリケーションサービス (今回は Web サーバ) の通信が成立します。

* 演習の範囲を超えるので扱いませんが、TCP の状態管理など、通信制御(パケットフィルタ)に影響する要素は他にもあります。
* 実際の業務システムではよりレイヤの高いセキュリティ機器などが入ることがあります。
* 環境内に LB, Proxy, NAT (IP アドレス変換) がある場合、リクエストの送信元・送信先が経路中で変わっていくことがあります。そうした場合のフィルタルールには注意してください。

<!-- FOOTER -->

---

[Previous](../l4nw3/question.md) << [Index](../index.md) >> [Next](../app1/question.md)
<!-- /FOOTER -->
